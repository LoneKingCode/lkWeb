@using lkWeb.Areas.Admin.Models
@using lkWeb.Service.Enum;
@using System.Text;
@using System.Text.Encodings.Web;
@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout_Content.cshtml";
    ViewBag.Title = "添加数据";
}
@model ViewListModel

@section Styles{
    <style type="text/css">
        .table > tbody > tr > td {
            border: none;
        }
    </style>

    <style type="text/css">
     @Html.Raw(Model.Table.AddPageCssStyle)
    </style>

}

@section Scripts{
    <script type="text/javascript">
        @Html.Raw(Model.Table.EditPageJavaScript)

        $(function () {
            //加载富文本
            @{
                var richTextColumns= Model.TableColumn.Where(item => item.DataType == ColumnType.RichText).ToList();
                for (int i = 0; i < richTextColumns.Count; i++)
                {
                    @Html.Raw($"var editor{i} = UE.getEditor('{richTextColumns[i].Name}');")
                    @Html.Raw($"$('#{richTextColumns[i].Name}').css('width', (window.innerWidth - 100 * {Model.Table.ColumnPerRow+1}) + 'px').css('height', Math.round(window.innerHeight * 0.3) + 'px');")
                }
            }


            lkWeb.FormValidation($("#lkForm"), function () {
                lkWeb.RefreshAndClose()
            })

            //下拉单选
            $('.chosen-radio').chosen({
                ltl: true,
                width: "100%",
            });

            //下拉多选
            $('.chosen-checkbox').attr('data-placeholder', '请选择')
            $('.chosen-checkbox').chosen({
                allow_single_deselect: true,
                width: "100%",
            });

            //选择日期
            $('.datepicker-date').datePicker({
                hasShortcut: true,
                format: 'YYYY-MM-DD',
                shortcutOptions: [{
                    name: '今天',
                    day: '0'
                }, {
                    name: '昨天',
                    day: '-1'
                }, {
                    name: '一周前',
                    day: '-7'
                }]
            });
            //选择日期时间
            $('.datepicker-datetime').datePicker({
                format: 'YYYY-MM-DD HH:mm'
            });
        })
        function uploadFile(fileInputId, inputId, columnId) {
            lkWeb.Upload(fileInputId, '@Url.Action("Upload")', { 'id': columnId }, function (result) {
                $("#" + inputId).val(result.data)
                })
        }
    </script>
}
<form class="form-horizontal" action="@Url.Action("Add",new { id = @Model.Table.Id })" method="post" id="lkForm">
    @Html.AntiForgeryToken()
    <table class="table table-content">
        <tbody>
            @{
                string inputTpl = "<input type=\"text\" class=\"form-control\" name=\"{1}\"  data-val=\"true\" {3} data-val-maxlength=\"{0}长度不能超过{2}个字符\" data-val-maxlength-max=\"{2}\"/>" +
"<span class=\"field-validation-valid\" data-valmsg-for=\"{1}\" data-valmsg-replace=\"true\"></span>";
                string dateTpl = "<div class=\"c-datepicker-date-editor c-datepicker-single-editor {0}\">" +
" <i class=\"c-datepicker-range__icon kxiconfont icon-clock\"></i>" +
"<input type = \"text\" autocomplete=\"off\" name=\"{1}\" placeholder=\"选择{2}\" data-val=\"true\" {3}  class=\"c-datepicker-data-input only-date\" value=\"\" style=\"width:100%;\"></div>" +
                "<span class=\"field-validation-valid\" data-valmsg-for=\"{1}\" data-valmsg-replace=\"true\"></span></div>";
                string editorTpl = "<script id=\"{0}\" name=\"{0}\" type=\"text/plain\" style=\"height:250px;\"></script>";
                StringBuilder sb = new StringBuilder();
                var numPerRow = Model.Table.ColumnPerRow < 1 ? 1 : Model.Table.ColumnPerRow;
                var count = 0;
                sb.Append("<tr>");
                foreach (var column in Model.TableColumn)
                {
                    count++;
                    var colspan = 1;
                    if (column.ColSpan > 1)
                    {
                        colspan = column.ColSpan;
                    }
                    var requireSpan = column.Required == 1 ? "<span class='require'>*</span>":"";
                    string tempTpl = "<td class='td-left'>" + requireSpan + "<span class='name'>" + column.Description + "</span></td><td colspan='" + colspan + "'>{0}</td>";
                    if (column.DataType == ColumnType.Out || column.DataType == ColumnType.Enum)
                    {
                        var content = Html.DropDownList(column.Name, (SelectList)ViewData[column.Name], new { @class = "form-control  chosen-radio" });
                        var writer = new System.IO.StringWriter();
                        content.WriteTo(writer, HtmlEncoder.Default);
                        var sltHtml = writer.ToString();
                        sb.Append(string.Format(tempTpl, sltHtml));
                    }

                    else if (column.DataType == ColumnType.CheckBox)
                    {
                        var htmlAttr = new { @class = "chosen-checkbox", multiple = "multiple", id = "chosen-" + column.Name };
                        var content = Html.DropDownList(column.Name, (SelectList)ViewData[column.Name], htmlAttr);
                        var writer = new System.IO.StringWriter();
                        content.WriteTo(writer, HtmlEncoder.Default);
                        var sltHtml = writer.ToString();
                        sb.Append(string.Format(tempTpl, sltHtml));
                    }
                    else if (column.DataType == ColumnType.Date || column.DataType == ColumnType.Datetime)
                    {
                        string _class = column.DataType == "Date" ? "datepicker-date" : "datepicker-datetime";
                        string type = column.DataType == "Date" ? "日期" : "时间";
                        string contentHtml = string.Format(dateTpl, _class, column.Name, type,
                                column.Required == 1 ? "data-val-required=\"" + column.Description + "不能为空\"" : "");
                        sb.Append(string.Format(tempTpl, contentHtml));

                    }
                    else if (column.DataType == ColumnType.File)
                    {
                        var contentHtml = string.Format(inputTpl, column.Description, column.Name,
                        column.MaxLength, $" readonly placeholder='请选择文件' id='{column.Name}'" +
                        (column.Required == 1 ? "data-val-required=\"" + column.Description + "不能为空\"" : "")
                        + $" onclick=\"$('#file{column.Name}').click()\" ");
                        sb.Append(string.Format(tempTpl, contentHtml));
                        sb.Append($"<input type='file' id='file{column.Name}' onchange='uploadFile(\"file{column.Name}\",\"{column.Name}\",\"{column.Id}\")' style='display:none;'/>");
                    }
                    else if (column.DataType == ColumnType.RichText)
                    {
                        var contentHtml = string.Format(editorTpl, column.Name);
                        sb.Append(string.Format(tempTpl, contentHtml));
                    }
                    else
                    {
                        var contentHtml = string.Format(inputTpl, column.Description, column.Name, column.MaxLength,
                            $" placeholder='请输入{column.Description}' " + column.ValidationRule + (column.Required == 1 ? " data-val-required=\"" + column.Description + "不能为空\"" : ""));
                        sb.Append(string.Format(tempTpl, contentHtml));
                    }
                    if (count % numPerRow == 0)
                    {
                        sb.Append("</tr>");
                        sb.Append("<tr>");
                    }
                }
                sb.Append("</tr>");
                @Html.Raw(sb.ToString());
            }

        </tbody>
        <tfoot>
            <tr>
                <td colspan="99">
                    <div class="form-group">
                        <div class="col-md-3 col-md-offset-5">
                            <button type="submit" class="btn btn-success">确定</button>
                            <button type="button" class="btn btn-default" onclick="lkWeb.Close()">返回</button>

                        </div>
                    </div>
                </td>
            </tr>
        </tfoot>
    </table>

</form>

