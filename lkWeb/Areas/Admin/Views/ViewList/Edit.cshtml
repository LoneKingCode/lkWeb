@using lkWeb.Areas.Admin.Models
@using lkWeb.Service.Enum;
@using System.Text;
@using System.Text.Encodings.Web;
@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout_Content.cshtml";
    ViewBag.Title = "编辑数据";
}
@model ViewListModel

@section Styles{
    <style type="text/css">
        .table > tbody > tr > td {
            border: none;
        }
    </style>
    <style type="text/css">
     @Html.Raw(Model.Table.CustomCssStyle)
    </style>
}
@section Scripts{
    <script src="~/js/admin/viewlist.js" asp-append-version="true"></script>
    <script type="text/javascript">
        @Html.Raw(Model.Table.EditPageJavaScript)

        $(function () {
            //加载富文本
            @{
                var richTextColumns= Model.TableColumn.Where(item => item.DataType == ColumnType.RichText).ToList();
                for (int i = 0; i < richTextColumns.Count; i++)
                {
                    @Html.Raw($"var editor{i} = UE.getEditor('{richTextColumns[i].Name}');")
                    @Html.Raw($"$('#{richTextColumns[i].Name}').css('width', (window.innerWidth - 103 * {Model.Table.ColumnPerRow+1}) + 'px').css('height', Math.round(window.innerHeight * 0.3) + 'px');")
                }
            }


        })

    </script>
}
<form class="form-horizontal" action="@Url.Action("Edit")" method="post" id="lkForm">
    @Html.AntiForgeryToken()
    <table class="table table-content">
        <tbody>
            @{
                string textareaTpl = "<textarea class=\"form-control\" name=\"{0}\" rows=\"3\">{1}</textarea>";

                string inputTpl = "<input type=\"text\" class=\"form-control\" name=\"{1}\"  value=\"{4}\" data-val=\"true\" {3} data-val-maxlength=\"{0}长度不能超过{2}个字符\" data-val-maxlength-max=\"{2}\"/>" +
"<span class=\"field-validation-valid\" data-valmsg-for=\"{1}\" data-valmsg-replace=\"true\"></span>";
                string editorTpl = "<script id=\"{0}\" name=\"{0}\" type=\"text/plain\" style=\"height:250px;\">{1}</script>";
                string validateTpl = "<span class=\"field-validation-valid\" data-valmsg-for=\"{0}\" data-valmsg-replace=\"true\"></span>";
                var dateTpl = "<div class='input-group'>" +
"<input class=\"form-control datetimepicker\" readonly type=\"text\" name=\"{0}\" value=\"{2}\" data-date-format=\"{1}\" data-val=\"true\" {3}>" +
"<span class=\"input-group-addon\"><i class=\"fa fa-calendar\"></i></span><span class=\"field-validation-valid\" data-valmsg-for=\"{0}\" data-valmsg-replace=\"true\"></span></div>";

                StringBuilder sb = new StringBuilder();
                var numPerRow = Model.Table.ColumnPerRow < 1 ? 1 : Model.Table.ColumnPerRow;
                var count = 0;
                sb.Append("<tr>");
                foreach (var column in Model.TableColumn)
                {
                    count++;
                    var colspan = 1;
                    if (column.ColSpan > 1)
                    {
                        colspan = column.ColSpan;
                    }
                    var requireSpan = column.Required == 1 ? "<span class='require'>*</span>" : "";
                    string tempTpl = "<td class='td-left'>" + requireSpan + "<span class='name'>" + column.Description + "</span></td><td colspan='" + colspan + "'>{0}</td>";
                    if (column.DataType == ColumnType.Out || column.DataType == ColumnType.Enum)
                    {
                        var content = Html.DropDownList(column.Name, (SelectList)ViewData[column.Name], new { @class = "form-control select" });
                        var writer = new System.IO.StringWriter();
                        content.WriteTo(writer, HtmlEncoder.Default);
                        var sltHtml = writer.ToString();
                        sb.Append(string.Format(tempTpl, sltHtml));
                    }
                    else if (column.DataType == ColumnType.MultiSelect || column.DataType == ColumnType.MultiSelect_Out)
                    {
                        var htmlAttr = new Dictionary<string, object> { { "class", "form-control select" }, { "multiple", "multiple" }, { "id", column.Name },
                                                    { "data-val","true"},{"data-valmsg-for","请选择"+column.Description },{ "data-valmsg-replace","true"} };
                        var content = Html.DropDownList(column.Name, (MultiSelectList)ViewData[column.Name], htmlAttr);

                        var writer = new System.IO.StringWriter();
                        content.WriteTo(writer, HtmlEncoder.Default);
                        var sltHtml = writer.ToString() + string.Format(validateTpl, column.Name);
                        sb.Append(string.Format(tempTpl, sltHtml));
                    }
                    else if (column.DataType == ColumnType.Datetime)
                    {
                        string contentHtml = string.Format(dateTpl, column.Name, column.DateFormat, ViewBag.ColumnValue[column.Name],
                                    column.Required == 1 ? "data-val-required=\"" + column.Description + "不能为空\"" : "");
                        sb.Append(string.Format(tempTpl, contentHtml));

                    }
                    else if (column.DataType == ColumnType.File)
                    {
                        var contentHtml = string.Format(inputTpl, column.Description, column.Name, column.MaxLength,
                            $" readonly placeholder='请选择文件' id='{column.Name}'" +
                        (column.Required == 1 ? "data-val-required=\"" + column.Description + "不能为空\"" : "")
                        + $" onclick=\"$('#file{column.Name}').click()\" ", ViewBag.ColumnValue[column.Name]);
                        sb.Append(string.Format(tempTpl, contentHtml));
                        sb.Append($"<input type='file' id='file{column.Name}' onchange='uploadFile(\"{Url.Action("Upload")}\",\"file{column.Name}\",\"{column.Name}\",\"{column.Id}\")' style='display:none;'/>");
                    }
                    else if (column.DataType == ColumnType.RichText)
                    {
                        sb.Append("<tr>");
                        var contentHtml = string.Format(editorTpl, column.Name, ViewBag.ColumnValue[column.Name]);
                        sb.Append(string.Format(tempTpl, contentHtml));
                        sb.Append("</tr>");
                        count++;
                        continue;
                    }
                    else if (column.DataType == ColumnType.MultiLine_String)
                    {
                        var contentHtml = string.Format(textareaTpl, column.Name, ViewBag.ColumnValue[column.Name]);
                        sb.Append(string.Format(tempTpl, contentHtml));
                    }
                    else
                    {
                        var contentHtml = string.Format(inputTpl, column.Description, column.Name, column.MaxLength,
                            $" placeholder='请输入{column.Description}' " + column.ValidationRule + (column.Required == 1 ? " data-val-required=\"" + column.Description + "不能为空\"" : ""),
                            ViewBag.ColumnValue[column.Name]);
                        sb.Append(string.Format(tempTpl, contentHtml));
                    }
                    if (count % numPerRow == 0)
                    {
                        sb.Append("</tr>");
                        sb.Append("<tr>");
                    }
                }
                sb.Append("</tr>");
                @Html.Raw(sb.ToString());
            }

        </tbody>
        <tfoot>
            <tr>
                <td colspan="99">
                    <div class="form-group">
                        <div class="col-md-3 col-md-offset-5">
                            <button type="submit" class="btn btn-success">确定</button>
                            <button type="button" class="btn btn-default" onclick="lkWeb.Close()">返回</button>
                        </div>
                    </div>
                </td>
            </tr>
        </tfoot>
    </table>
</form>